<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nudge — AI execution companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
      };
    </script>
  </head>
  <body class="min-h-screen bg-slate-950 text-slate-100">
    <main class="mx-auto flex min-h-screen w-full max-w-3xl flex-col px-4 py-10">
      <section class="mb-8 text-center">
        <h1 class="text-3xl font-semibold tracking-tight">Nudge</h1>
        <p class="mt-2 text-slate-300">Your AI execution companion for ADHD brains.</p>
      </section>

      <section id="onboarding" class="space-y-6 rounded-3xl border border-slate-800 bg-slate-900/60 p-6 shadow-xl">
        <div id="onboarding-step-1" class="space-y-4">
          <p class="text-lg">Hey, I'm Nudge. What should I call you?</p>
          <input
            id="name-input"
            type="text"
            placeholder="Your name"
            class="w-full rounded-2xl border border-slate-700 bg-slate-950 px-4 py-3 text-base text-slate-100 placeholder:text-slate-500 focus:border-indigo-400 focus:outline-none"
          />
          <button
            id="name-next"
            class="w-full rounded-2xl bg-indigo-500 px-4 py-3 text-base font-semibold text-white transition hover:bg-indigo-400"
          >
            Continue
          </button>
        </div>

        <div id="onboarding-step-2" class="hidden space-y-4">
          <p class="text-lg" id="struggle-greeting"></p>
          <div class="grid gap-3">
            <button class="struggle-option rounded-2xl border border-slate-700 bg-slate-950 px-4 py-3 text-left text-base hover:border-indigo-400">
              I know what to do but can't start
            </button>
            <button class="struggle-option rounded-2xl border border-slate-700 bg-slate-950 px-4 py-3 text-left text-base hover:border-indigo-400">
              Everything feels overwhelming
            </button>
            <button class="struggle-option rounded-2xl border border-slate-700 bg-slate-950 px-4 py-3 text-left text-base hover:border-indigo-400">
              I get distracted easily
            </button>
            <button class="struggle-option rounded-2xl border border-slate-700 bg-slate-950 px-4 py-3 text-left text-base hover:border-indigo-400">
              I just freeze up
            </button>
          </div>
        </div>

        <div id="onboarding-step-3" class="hidden space-y-4 text-center">
          <p class="text-lg">I'm not going to lecture you. Just tiny steps so small your brain can't say no. Ready?</p>
          <button
            id="onboarding-complete"
            class="w-full rounded-2xl bg-indigo-500 px-4 py-3 text-base font-semibold text-white transition hover:bg-indigo-400"
          >
            Let's do this
          </button>
        </div>
      </section>

      <section id="app" class="mt-8 hidden space-y-6">
        <div class="rounded-3xl border border-slate-800 bg-slate-900/60 p-6 shadow-xl">
          <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
            <div>
              <p class="text-sm uppercase tracking-[0.3em] text-slate-400">Support Mode</p>
              <h2 class="text-2xl font-semibold" id="welcome-message">Hey there.</h2>
              <p class="mt-2 text-slate-300">Okay <span id="name-inline"></span>, that sounds big. Let's make it tiny.</p>
            </div>
            <div class="w-full max-w-xs space-y-2">
              <label class="text-xs uppercase tracking-[0.3em] text-slate-400">OpenAI API key</label>
              <input
                id="api-key"
                type="password"
                placeholder="sk-..."
                class="w-full rounded-2xl border border-slate-700 bg-slate-950 px-4 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:border-indigo-400 focus:outline-none"
              />
              <p class="text-xs text-slate-500">Stored locally in your browser.</p>
            </div>
          </div>
        </div>

        <div class="rounded-3xl border border-slate-800 bg-slate-900/60 p-6 shadow-xl">
          <label class="text-sm uppercase tracking-[0.3em] text-slate-400">What are you avoiding?</label>
          <textarea
            id="task-input"
            rows="3"
            placeholder="Example: write the project proposal"
            class="mt-3 w-full resize-none rounded-2xl border border-slate-700 bg-slate-950 px-4 py-3 text-base text-slate-100 placeholder:text-slate-500 focus:border-indigo-400 focus:outline-none"
          ></textarea>
          <button
            id="breakdown-button"
            class="mt-4 w-full rounded-2xl bg-emerald-500 px-4 py-3 text-base font-semibold text-slate-950 transition hover:bg-emerald-400"
          >
            Break it into tiny steps
          </button>
          <p id="status-message" class="mt-3 text-sm text-slate-400"></p>
        </div>

        <div id="reward-banner" class="hidden rounded-3xl border border-amber-400/40 bg-amber-500/10 p-6 text-amber-200 shadow-xl"></div>

        <div id="steps-card" class="hidden rounded-3xl border border-slate-800 bg-slate-900/60 p-6 shadow-xl">
          <div class="flex items-center justify-between">
            <p class="text-sm uppercase tracking-[0.3em] text-slate-400">Current tiny step</p>
            <p class="text-sm text-slate-400"><span id="step-count">1</span>/<span id="step-total">0</span></p>
          </div>
          <div class="mt-4 text-xl font-semibold" id="current-step">Step goes here</div>
          <div class="mt-6 flex flex-col gap-3 sm:flex-row">
            <button
              id="done-button"
              class="flex-1 rounded-2xl bg-indigo-500 px-4 py-3 text-base font-semibold text-white transition hover:bg-indigo-400"
            >
              Done
            </button>
            <button
              id="skip-button"
              class="flex-1 rounded-2xl border border-slate-700 bg-slate-950 px-4 py-3 text-base font-semibold text-slate-200 transition hover:border-indigo-400"
            >
              Skip
            </button>
          </div>
          <div class="mt-6 h-3 w-full overflow-hidden rounded-full bg-slate-800">
            <div id="progress-bar" class="h-full w-0 rounded-full bg-emerald-400 transition-all"></div>
          </div>
        </div>

        <div id="completion-card" class="hidden rounded-3xl border border-emerald-400/40 bg-emerald-500/10 p-6 text-center text-emerald-200 shadow-xl">
          <h3 class="text-2xl font-semibold">You did it!</h3>
          <p class="mt-2 text-sm text-emerald-100">Every tiny step counts. Come back whenever you need a nudge.</p>
        </div>
      </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <script>
      const onboarding = document.getElementById('onboarding');
      const onboardingStep1 = document.getElementById('onboarding-step-1');
      const onboardingStep2 = document.getElementById('onboarding-step-2');
      const onboardingStep3 = document.getElementById('onboarding-step-3');
      const nameInput = document.getElementById('name-input');
      const nameNext = document.getElementById('name-next');
      const struggleGreeting = document.getElementById('struggle-greeting');
      const struggleOptions = document.querySelectorAll('.struggle-option');
      const onboardingComplete = document.getElementById('onboarding-complete');

      const app = document.getElementById('app');
      const apiKeyInput = document.getElementById('api-key');
      const taskInput = document.getElementById('task-input');
      const breakdownButton = document.getElementById('breakdown-button');
      const statusMessage = document.getElementById('status-message');
      const stepsCard = document.getElementById('steps-card');
      const currentStep = document.getElementById('current-step');
      const stepCount = document.getElementById('step-count');
      const stepTotal = document.getElementById('step-total');
      const doneButton = document.getElementById('done-button');
      const skipButton = document.getElementById('skip-button');
      const progressBar = document.getElementById('progress-bar');
      const completionCard = document.getElementById('completion-card');
      const rewardBanner = document.getElementById('reward-banner');
      const nameInline = document.getElementById('name-inline');
      const welcomeMessage = document.getElementById('welcome-message');

      const state = {
        name: localStorage.getItem('nudge.name') || '',
        struggle: localStorage.getItem('nudge.struggle') || '',
        apiKey: localStorage.getItem('nudge.apiKey') || '',
        steps: [],
        currentIndex: 0,
        rewardMode: 'normal',
      };

      const rewardMessages = {
        extra: "You're not alone in this. I'm right here with you.",
        celebration: '',
      };

      const updateWelcome = () => {
        welcomeMessage.textContent = state.name ? `Hey ${state.name}.` : 'Hey there.';
        nameInline.textContent = state.name || 'friend';
      };

      const showOnboardingStep = (step) => {
        onboardingStep1.classList.toggle('hidden', step !== 1);
        onboardingStep2.classList.toggle('hidden', step !== 2);
        onboardingStep3.classList.toggle('hidden', step !== 3);
      };

      const completeOnboarding = () => {
        onboarding.classList.add('hidden');
        app.classList.remove('hidden');
        updateWelcome();
      };

      const init = () => {
        apiKeyInput.value = state.apiKey;
        updateWelcome();

        if (!state.name) {
          showOnboardingStep(1);
          return;
        }
        if (!state.struggle) {
          struggleGreeting.textContent = `Nice to meet you, ${state.name}. What's holding you back?`;
          showOnboardingStep(2);
          return;
        }
        completeOnboarding();
      };

      nameNext.addEventListener('click', () => {
        const nameValue = nameInput.value.trim();
        if (!nameValue) {
          nameInput.focus();
          return;
        }
        state.name = nameValue;
        localStorage.setItem('nudge.name', state.name);
        struggleGreeting.textContent = `Nice to meet you, ${state.name}. What's holding you back?`;
        showOnboardingStep(2);
      });

      struggleOptions.forEach((button) => {
        button.addEventListener('click', () => {
          state.struggle = button.textContent.trim();
          localStorage.setItem('nudge.struggle', state.struggle);
          showOnboardingStep(3);
        });
      });

      onboardingComplete.addEventListener('click', () => {
        completeOnboarding();
      });

      apiKeyInput.addEventListener('input', (event) => {
        state.apiKey = event.target.value.trim();
        localStorage.setItem('nudge.apiKey', state.apiKey);
      });

      const rollRewardMode = () => {
        const roll = Math.random();
        if (roll < 0.1) return 'celebration';
        if (roll < 0.3) return 'extra';
        return 'normal';
      };

      const buildPrompt = (task, mode) => {
        const base = `You are Nudge, a warm, understanding, never-preachy companion for ADHD brains. Break the task into 5-10 micro-steps. Keep each step under 12 words. Output only a numbered list.`;
        if (mode === 'extra') {
          return `${base} Add a short, encouraging sentence after the list.`;
        }
        if (mode === 'celebration') {
          return `${base} Include a celebratory tone and reference ${state.name} once.`;
        }
        return base;
      };

      const parseSteps = (content) =>
        content
          .split('\n')
          .map((line) => line.replace(/^\s*\d+[\).\-]*\s*/, '').trim())
          .filter((line) => line.length > 0 && !line.match(/encouraging/i));

      const updateProgress = () => {
        const total = state.steps.length;
        const completed = Math.min(state.currentIndex, total);
        const percent = total ? Math.round((completed / total) * 100) : 0;
        progressBar.style.width = `${percent}%`;
        stepCount.textContent = Math.min(state.currentIndex + 1, total);
        stepTotal.textContent = total;
      };

      const showStep = () => {
        if (!state.steps.length) return;
        if (state.currentIndex >= state.steps.length) {
          stepsCard.classList.add('hidden');
          completionCard.classList.remove('hidden');
          confetti({ particleCount: 120, spread: 70, origin: { y: 0.6 } });
          return;
        }
        currentStep.textContent = state.steps[state.currentIndex];
        stepsCard.classList.remove('hidden');
        completionCard.classList.add('hidden');
        updateProgress();
      };

      const showRewardBanner = () => {
        if (state.rewardMode === 'extra') {
          rewardBanner.textContent = rewardMessages.extra;
          rewardBanner.classList.remove('hidden');
        } else if (state.rewardMode === 'celebration') {
          rewardBanner.textContent = `Celebration mode unlocked! ${state.name}, you've got this.`;
          rewardBanner.classList.remove('hidden');
        } else {
          rewardBanner.classList.add('hidden');
        }
      };

      const requestBreakdown = async () => {
        const task = taskInput.value.trim();
        if (!task) {
          statusMessage.textContent = 'Tell me what you are avoiding so I can break it down.';
          return;
        }
        if (!state.apiKey) {
          statusMessage.textContent = 'Add your OpenAI API key to get a breakdown.';
          return;
        }
        statusMessage.textContent = 'Brewing tiny steps…';
        breakdownButton.disabled = true;
        breakdownButton.classList.add('opacity-70', 'cursor-not-allowed');
        state.rewardMode = rollRewardMode();

        try {
          const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${state.apiKey}`,
            },
            body: JSON.stringify({
              model: 'gpt-4o-mini',
              messages: [
                { role: 'system', content: buildPrompt(task, state.rewardMode) },
                {
                  role: 'user',
                  content: `Task: ${task}\nStruggle: ${state.struggle}. Keep it gentle and tiny.`,
                },
              ],
              temperature: state.rewardMode === 'celebration' ? 0.7 : 0.5,
            }),
          });

          if (!response.ok) {
            throw new Error('API request failed');
          }

          const data = await response.json();
          const content = data.choices?.[0]?.message?.content || '';
          const steps = parseSteps(content);

          if (!steps.length) {
            throw new Error('No steps returned');
          }

          state.steps = steps;
          state.currentIndex = 0;
          statusMessage.textContent = 'Okay, tiny steps coming right up.';
          showRewardBanner();
          showStep();
        } catch (error) {
          statusMessage.textContent = 'I hit a snag. Double-check your API key and try again.';
          stepsCard.classList.add('hidden');
        } finally {
          breakdownButton.disabled = false;
          breakdownButton.classList.remove('opacity-70', 'cursor-not-allowed');
        }
      };

      breakdownButton.addEventListener('click', requestBreakdown);

      doneButton.addEventListener('click', () => {
        state.currentIndex += 1;
        showStep();
      });

      skipButton.addEventListener('click', () => {
        state.currentIndex += 1;
        showStep();
      });

      init();
    </script>
  </body>
</html>
