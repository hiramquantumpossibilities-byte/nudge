<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nudge v2 — a breathtaking ADHD companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              display: ['Outfit', 'ui-sans-serif', 'system-ui'],
              body: ['Space Grotesk', 'ui-sans-serif', 'system-ui'],
            },
            boxShadow: {
              glow: '0 0 40px rgba(99, 102, 241, 0.35), 0 0 120px rgba(56, 189, 248, 0.2)',
            },
          },
        },
      };
    </script>
    <style>
      :root {
        color-scheme: dark;
      }

      html {
        scroll-behavior: smooth;
      }

      body {
        font-family: 'Space Grotesk', system-ui, sans-serif;
      }

      .aurora {
        background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.25), transparent 45%),
          radial-gradient(circle at 20% 20%, rgba(99, 102, 241, 0.22), transparent 40%),
          radial-gradient(circle at 90% 10%, rgba(236, 72, 153, 0.18), transparent 40%),
          radial-gradient(circle at 80% 70%, rgba(16, 185, 129, 0.15), transparent 45%),
          #05060f;
      }

      .glass {
        backdrop-filter: blur(28px);
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.85), rgba(15, 23, 42, 0.55));
        border: 1px solid rgba(148, 163, 184, 0.15);
      }

      .floating {
        animation: float 12s ease-in-out infinite;
      }

      .floating-slow {
        animation: float 18s ease-in-out infinite;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-12px);
        }
      }

      .glow-button {
        position: relative;
        overflow: hidden;
      }

      .glow-button::after {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(120deg, rgba(255, 255, 255, 0.2), transparent 60%);
        transform: translateX(-120%);
        transition: transform 0.6s ease;
      }

      .glow-button:hover::after,
      .glow-button:focus-visible::after {
        transform: translateX(0%);
      }

      .pulse-border {
        box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.35), 0 0 30px rgba(59, 130, 246, 0.2);
      }

      .google-btn {
        background: white;
        color: #333;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
      }

      .google-btn:hover {
        background: #f8f8f8;
      }

      .spinner {
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-top: 3px solid white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body class="aurora min-h-screen text-slate-100">
    <main class="relative mx-auto flex min-h-screen w-full max-w-5xl flex-col px-5 py-12">
      <div class="pointer-events-none absolute inset-0 overflow-hidden">
        <div class="floating absolute left-6 top-10 h-32 w-32 rounded-full bg-indigo-500/20 blur-3xl"></div>
        <div class="floating-slow absolute right-10 top-32 h-40 w-40 rounded-full bg-emerald-400/20 blur-3xl"></div>
        <div class="floating absolute bottom-10 left-1/3 h-48 w-48 rounded-full bg-fuchsia-500/20 blur-3xl"></div>
      </div>

      <!-- LOADING STATE -->
      <section id="loading-screen" class="relative z-10 flex flex-col items-center justify-center min-h-[60vh]">
        <div class="spinner mb-4"></div>
        <p class="text-slate-400">Loading Nudge...</p>
        <button id="skip-loading" class="hidden mt-6 text-sm text-indigo-400 hover:text-indigo-300 underline underline-offset-4" onclick="window.__skipToAuth && window.__skipToAuth()">
          Taking too long? Tap here
        </button>
      </section>
      <script>
        // Absolute failsafe - shows escape after 3s, forces auth after 8s
        setTimeout(() => {
          const skipBtn = document.getElementById('skip-loading');
          const loadingScreen = document.getElementById('loading-screen');
          if (skipBtn && loadingScreen && !loadingScreen.classList.contains('hidden')) {
            skipBtn.classList.remove('hidden');
          }
        }, 3000);
        setTimeout(() => {
          const loadingScreen = document.getElementById('loading-screen');
          const authSection = document.getElementById('auth-section');
          if (loadingScreen && !loadingScreen.classList.contains('hidden')) {
            console.warn('[NUDGE] Absolute failsafe triggered - forcing auth screen');
            loadingScreen.classList.add('hidden');
            authSection?.classList.remove('hidden');
          }
        }, 8000);
        window.__skipToAuth = () => {
          const loadingScreen = document.getElementById('loading-screen');
          const authSection = document.getElementById('auth-section');
          loadingScreen?.classList.add('hidden');
          authSection?.classList.remove('hidden');
        };
      </script>

      <!-- AUTH SECTION - Login/Signup -->
      <section id="auth-section" class="hidden relative z-10">
        <div class="text-center mb-10">
          <p class="text-xs uppercase tracking-[0.5em] text-slate-400">Nudge v2</p>
          <h1 class="mt-3 text-4xl font-semibold tracking-tight text-white sm:text-5xl">
            A breathtaking companion for starting tiny.
          </h1>
          <p class="mx-auto mt-4 max-w-2xl text-base text-slate-300 sm:text-lg">
            Built for bright, overwhelmed brains. We skip guilt, skip pressure, and just make the next step feel possible.
          </p>
        </div>

        <div class="glass pulse-border rounded-[32px] p-6 shadow-glow sm:p-8 max-w-md mx-auto">
          <h2 class="font-display text-2xl text-center mb-6">Get Started</h2>
          <p class="text-slate-300 text-center mb-6">Sign in to access your personal ADHD companion.</p>
          
          <button id="google-login-btn" class="google-btn glow-button w-full rounded-2xl px-4 py-3 text-base font-semibold transition">
            <svg width="20" height="20" viewBox="0 0 24 24">
              <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            Continue with Google
          </button>

          <div class="my-6 flex items-center gap-3 text-xs uppercase tracking-[0.4em] text-slate-500">
            <span class="h-px flex-1 bg-slate-700/60"></span>
            <span>or</span>
            <span class="h-px flex-1 bg-slate-700/60"></span>
          </div>

          <div class="space-y-3">
            <input
              id="email-input"
              type="email"
              placeholder="you@example.com"
              class="w-full rounded-2xl border border-slate-700/50 bg-slate-900/70 px-4 py-3 text-base text-slate-100 placeholder:text-slate-500 focus:border-indigo-400 focus:outline-none"
            />
            <button
              id="email-login-btn"
              class="glow-button w-full rounded-2xl bg-slate-800 px-4 py-3 text-base font-semibold text-white transition hover:bg-slate-700"
            >
              Email me a sign-in link
            </button>
          </div>

          <div class="mt-6 text-center text-sm text-slate-400">
            <p>By signing in, you agree to our <a href="#" class="text-indigo-400 hover:underline">Terms</a> and <a href="#" class="text-indigo-400 hover:underline">Privacy Policy</a>.</p>
          </div>
        </div>

        <div class="mt-8 text-center">
          <div class="glass rounded-2xl p-4 inline-block">
            <p class="text-sm text-slate-300">✨ <strong>Subscription pricing:</strong> $7/mo or $60/year (save $24)</p>
          </div>
        </div>
      </section>

      <!-- PAYMENT SECTION - Paywall -->
      <section id="payment-section" class="hidden relative z-10">
        <div class="text-center mb-10">
          <p class="text-xs uppercase tracking-[0.5em] text-slate-400">Almost there!</p>
          <h1 class="mt-3 text-4xl font-semibold tracking-tight text-white sm:text-5xl">
            Unlock Nudge
          </h1>
          <p class="mx-auto mt-4 max-w-2xl text-base text-slate-300 sm:text-lg">
            Choose a flexible subscription and keep Nudge working for you.
          </p>
        </div>

        <div class="glass pulse-border rounded-[32px] p-6 shadow-glow sm:p-8 max-w-md mx-auto">
          <!-- Pricing Toggle -->
          <div class="flex justify-center mb-6">
            <div class="inline-flex rounded-xl bg-slate-800/80 p-1">
              <button id="plan-monthly" class="plan-toggle px-4 py-2 rounded-lg text-sm font-medium transition-all bg-emerald-500 text-slate-950">Monthly</button>
              <button id="plan-annual" class="plan-toggle px-4 py-2 rounded-lg text-sm font-medium transition-all text-slate-400 hover:text-white">Annual</button>
            </div>
          </div>

          <!-- Monthly Price -->
          <div id="price-monthly" class="text-center mb-6">
            <p class="text-xs uppercase tracking-[0.4em] text-slate-400 mb-3">Monthly</p>
            <div class="rounded-2xl border border-slate-700/60 bg-slate-900/70 px-4 py-4">
              <div class="text-3xl font-bold text-white">$7</div>
              <p class="text-sm text-slate-400">per month</p>
            </div>
          </div>

          <!-- Annual Price (hidden by default) -->
          <div id="price-annual" class="text-center mb-6 hidden">
            <p class="text-xs uppercase tracking-[0.4em] text-slate-400 mb-3">Annual</p>
            <div class="rounded-2xl border border-emerald-500/40 bg-slate-900/70 px-4 py-4 relative">
              <div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-emerald-500 text-slate-950 text-xs font-bold px-3 py-1 rounded-full">SAVE $24</div>
              <div class="text-3xl font-bold text-white">$60</div>
              <p class="text-sm text-slate-400">per year <span class="text-emerald-400">($5/mo)</span></p>
            </div>
          </div>

          <ul class="space-y-3 mb-6 text-slate-300">
            <li class="flex items-center gap-3">
              <span class="text-emerald-400">✓</span> Full access while subscribed
            </li>
            <li class="flex items-center gap-3">
              <span class="text-emerald-400">✓</span> AI-powered task breakdown
            </li>
            <li class="flex items-center gap-3">
              <span class="text-emerald-400">✓</span> Personalized ADHD support
            </li>
            <li class="flex items-center gap-3">
              <span class="text-emerald-400">✓</span> All future updates included
            </li>
            <li class="flex items-center gap-3">
              <span class="text-emerald-400">✓</span> Cancel anytime
            </li>
          </ul>

          <button id="checkout-btn" class="glow-button w-full rounded-2xl bg-emerald-400 px-4 py-4 text-base font-semibold text-slate-950 transition hover:bg-emerald-300">
            <span id="checkout-btn-text">Subscribe for $7/month</span>
          </button>

          <p class="mt-4 text-center text-sm text-slate-400">
            Secure payment via Stripe. Cancel anytime.
          </p>
        </div>

        <div class="mt-6 text-center">
          <button id="logout-btn-payment" class="text-sm text-slate-400 hover:text-slate-200 underline">
            Sign out
          </button>
        </div>
      </section>

      <!-- APP HEADER -->
      <section id="app-header" class="hidden relative z-10 mb-10 text-center">
        <div class="flex justify-between items-center mb-4">
          <p class="text-xs uppercase tracking-[0.5em] text-slate-400">Nudge v2</p>
          <button id="logout-btn" class="text-sm text-slate-400 hover:text-slate-200 flex items-center gap-2">
            <span id="user-email" class="text-xs"></span>
            <span class="underline">Sign out</span>
          </button>
        </div>
        <h1 class="mt-3 text-4xl font-semibold tracking-tight text-white sm:text-5xl">
          A breathtaking companion for starting tiny.
        </h1>
        <p class="mx-auto mt-4 max-w-2xl text-base text-slate-300 sm:text-lg">
          Built for bright, overwhelmed brains. We skip guilt, skip pressure, and just make the next step feel possible.
        </p>
      </section>

      <!-- ONBOARDING -->
      <section id="onboarding" class="hidden glass pulse-border relative z-10 space-y-6 rounded-[32px] p-6 shadow-glow sm:p-8">
        <div id="onboarding-step-1" class="space-y-4">
          <p class="font-display text-lg sm:text-xl">Hey, I'm Nudge. What should I call you?</p>
          <input
            id="name-input"
            type="text"
            placeholder="Your name"
            class="w-full rounded-2xl border border-slate-700/50 bg-slate-900/70 px-4 py-3 text-base text-slate-100 placeholder:text-slate-500 focus:border-indigo-400 focus:outline-none"
          />
          <button
            id="name-next"
            class="glow-button w-full rounded-2xl bg-indigo-500 px-4 py-3 text-base font-semibold text-white transition hover:bg-indigo-400"
          >
            Continue
          </button>
        </div>

        <div id="onboarding-step-2" class="hidden space-y-4">
          <p class="font-display text-lg sm:text-xl" id="struggle-greeting"></p>
          <div class="grid gap-3 sm:grid-cols-2">
            <button class="struggle-option rounded-2xl border border-slate-700/50 bg-slate-900/70 px-4 py-3 text-left text-sm text-slate-200 transition hover:border-indigo-400">
              I know what to do but can't begin
            </button>
            <button class="struggle-option rounded-2xl border border-slate-700/50 bg-slate-900/70 px-4 py-3 text-left text-sm text-slate-200 transition hover:border-indigo-400">
              My brain screams and goes blank
            </button>
            <button class="struggle-option rounded-2xl border border-slate-700/50 bg-slate-900/70 px-4 py-3 text-left text-sm text-slate-200 transition hover:border-indigo-400">
              Every task feels like a mountain
            </button>
            <button class="struggle-option rounded-2xl border border-slate-700/50 bg-slate-900/70 px-4 py-3 text-left text-sm text-slate-200 transition hover:border-indigo-400">
              I freeze and then feel guilty
            </button>
          </div>
          <textarea
            id="struggle-input"
            rows="3"
            placeholder="Or tell me in your own words..."
            class="w-full resize-none rounded-2xl border border-slate-700/50 bg-slate-900/70 px-4 py-3 text-base text-slate-100 placeholder:text-slate-500 focus:border-indigo-400 focus:outline-none"
          ></textarea>
          <button
            id="struggle-next"
            class="glow-button w-full rounded-2xl bg-indigo-500 px-4 py-3 text-base font-semibold text-white transition hover:bg-indigo-400"
          >
            That's me
          </button>
        </div>

        <div id="onboarding-step-3" class="hidden space-y-4 text-center">
          <p class="text-lg sm:text-xl">
            Tiny steps only. No lectures. No streaks. You can skip anything, anytime.
          </p>
          <button
            id="onboarding-complete"
            class="glow-button w-full rounded-2xl bg-emerald-400 px-4 py-3 text-base font-semibold text-slate-950 transition hover:bg-emerald-300"
          >
            Let's make today lighter
          </button>
        </div>
      </section>

      <!-- MAIN APP -->
      <section id="app" class="relative z-10 hidden space-y-6">
        <div class="glass pulse-border rounded-[32px] p-6 shadow-glow sm:p-8">
          <div>
            <p class="text-xs uppercase tracking-[0.4em] text-slate-400">Support Mode</p>
            <h2 class="font-display text-2xl sm:text-3xl" id="welcome-message">Hey there.</h2>
            <p class="mt-2 text-slate-300">
              Okay <span id="name-inline"></span>, that sounds big. Let's make it tiny.
            </p>
          </div>
        </div>

        <div class="glass pulse-border rounded-[32px] p-6 shadow-glow sm:p-8">
          <label class="text-xs uppercase tracking-[0.4em] text-slate-400">What are you avoiding?</label>
          <textarea
            id="task-input"
            rows="3"
            placeholder="Example: reply to my professor"
            class="mt-3 w-full resize-none rounded-2xl border border-slate-700/50 bg-slate-900/70 px-4 py-3 text-base text-slate-100 placeholder:text-slate-500 focus:border-indigo-400 focus:outline-none"
          ></textarea>
          <button
            id="breakdown-button"
            class="glow-button mt-4 w-full rounded-2xl bg-indigo-500 px-4 py-3 text-base font-semibold text-white transition hover:bg-indigo-400"
          >
            Break it into tiny steps
          </button>
          <p id="status-message" class="mt-3 text-sm text-slate-400"></p>
        </div>

        <div id="reward-banner" class="hidden rounded-[28px] border border-amber-400/40 bg-amber-500/10 p-6 text-amber-100 shadow-xl"></div>

        <div id="steps-card" class="glass pulse-border hidden rounded-[32px] p-6 shadow-glow sm:p-8">
          <div class="flex items-center justify-between text-xs uppercase tracking-[0.4em] text-slate-400">
            <span>Current tiny step</span>
            <span><span id="step-count">1</span>/<span id="step-total">0</span></span>
          </div>
          <div class="mt-4 text-xl font-semibold sm:text-2xl" id="current-step">Step goes here</div>
          <div class="mt-6 flex flex-col gap-3 sm:flex-row">
            <button
              id="done-button"
              class="glow-button flex-1 rounded-2xl bg-emerald-400 px-4 py-3 text-base font-semibold text-slate-950 transition hover:bg-emerald-300"
            >
              Done
            </button>
            <button
              id="skip-button"
              class="flex-1 rounded-2xl border border-slate-700/60 bg-slate-900/70 px-4 py-3 text-base font-semibold text-slate-200 transition hover:border-indigo-400"
            >
              Skip for now
            </button>
          </div>
          <div class="mt-6 h-3 w-full overflow-hidden rounded-full bg-slate-800">
            <div id="progress-bar" class="h-full w-0 rounded-full bg-emerald-300 transition-all"></div>
          </div>
        </div>

        <div
          id="completion-card"
          class="hidden rounded-[32px] border border-emerald-400/40 bg-emerald-500/10 p-6 text-center text-emerald-100 shadow-xl sm:p-8"
        >
          <h3 class="font-display text-2xl">You did it.</h3>
          <p class="mt-2 text-sm text-emerald-100">
            Every tiny step counts. Come back whenever you want a softer start.
          </p>
        </div>
      </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <script>
      console.log('[NUDGE] Script starting...');
      console.log('[NUDGE] window.supabase:', typeof window.supabase);
      // ==================== SUPABASE CONFIG ====================
      const SUPABASE_URL = 'https://cifkxrxnfbikcbtadbqv.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNpZmt4cnhuZmJpa2NidGFkYnF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3MzMwODYsImV4cCI6MjA4NTMwOTA4Nn0.gApzwCMN7vWzlWRTWFR4agIuZumCcKbLZGL-mL_Ih9k';
      const STRIPE_PAYMENT_LINK_MONTHLY = 'https://buy.stripe.com/00w9AVcsyc8faYS6LCcbC02';
      const STRIPE_PAYMENT_LINK_ANNUAL = 'https://buy.stripe.com/3cIbJ3fEKa07aYSda0cbC03';
      let selectedPlan = 'monthly';
      
      // Create Supabase client with error handling
      let supabase;
      try {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('Supabase client created successfully');
      } catch (e) {
        console.error('Failed to create Supabase client:', e);
        // Fallback - show auth screen
        document.getElementById('loading-screen')?.classList.add('hidden');
        document.getElementById('auth-section')?.classList.remove('hidden');
      }

      // ==================== DOM ELEMENTS ====================
      const loadingScreen = document.getElementById('loading-screen');
      const authSection = document.getElementById('auth-section');
      const paymentSection = document.getElementById('payment-section');
      const appHeader = document.getElementById('app-header');
      const onboarding = document.getElementById('onboarding');
      const onboardingStep1 = document.getElementById('onboarding-step-1');
      const onboardingStep2 = document.getElementById('onboarding-step-2');
      const onboardingStep3 = document.getElementById('onboarding-step-3');
      const nameInput = document.getElementById('name-input');
      const nameNext = document.getElementById('name-next');
      const emailInput = document.getElementById('email-input');
      const struggleGreeting = document.getElementById('struggle-greeting');
      const struggleOptions = document.querySelectorAll('.struggle-option');
      const struggleInput = document.getElementById('struggle-input');
      const struggleNext = document.getElementById('struggle-next');
      const onboardingCompleteBtn = document.getElementById('onboarding-complete');

      const app = document.getElementById('app');
      const taskInput = document.getElementById('task-input');
      const breakdownButton = document.getElementById('breakdown-button');
      const statusMessage = document.getElementById('status-message');
      const stepsCard = document.getElementById('steps-card');
      const currentStep = document.getElementById('current-step');
      const stepCount = document.getElementById('step-count');
      const stepTotal = document.getElementById('step-total');
      const doneButton = document.getElementById('done-button');
      const skipButton = document.getElementById('skip-button');
      const progressBar = document.getElementById('progress-bar');
      const completionCard = document.getElementById('completion-card');
      const rewardBanner = document.getElementById('reward-banner');
      const nameInline = document.getElementById('name-inline');
      const welcomeMessage = document.getElementById('welcome-message');
      const userEmailDisplay = document.getElementById('user-email');

      // ==================== STATE ====================
      const state = {
        user: null,
        userProfile: null,
        name: localStorage.getItem('nudge.name') || '',
        struggle: localStorage.getItem('nudge.struggle') || '',
        steps: [],
        currentIndex: 0,
        rewardMode: 'normal',
      };

      const AUTH_TIMEOUT_MS = 3000;

      const withTimeout = (promise, timeoutMs, label) =>
        new Promise((resolve, reject) => {
          const timer = setTimeout(() => reject(new Error(`${label} timeout`)), timeoutMs);
          promise
            .then((value) => {
              clearTimeout(timer);
              resolve(value);
            })
            .catch((error) => {
              clearTimeout(timer);
              reject(error);
            });
        });

      const ensureSupabase = () => {
        if (supabase) return true;
        console.error('Supabase client unavailable');
        alert('Auth is unavailable right now. Please refresh and try again.');
        return false;
      };

      // ==================== AUTH FUNCTIONS ====================
      const showScreen = (screen) => {
        loadingScreen.classList.add('hidden');
        authSection.classList.add('hidden');
        paymentSection.classList.add('hidden');
        appHeader.classList.add('hidden');
        onboarding.classList.add('hidden');
        app.classList.add('hidden');

        switch (screen) {
          case 'loading':
            loadingScreen.classList.remove('hidden');
            break;
          case 'auth':
            authSection.classList.remove('hidden');
            break;
          case 'payment':
            paymentSection.classList.remove('hidden');
            break;
          case 'app':
            appHeader.classList.remove('hidden');
            if (!state.name || !state.struggle) {
              onboarding.classList.remove('hidden');
            } else {
              app.classList.remove('hidden');
            }
            break;
        }
      };

      const signInWithGoogle = async () => {
        if (!ensureSupabase()) return;
        const { error } = await supabase.auth.signInWithOAuth({
          provider: 'google',
          options: {
            redirectTo: window.location.origin + window.location.pathname
          }
        });
        if (error) {
          console.error('Login error:', error);
          alert('Failed to sign in. Please try again.');
        }
      };

      const signInWithEmail = async () => {
        if (!ensureSupabase()) return;
        const email = emailInput.value.trim();
        if (!email) {
          emailInput.focus();
          return;
        }

        const { error } = await supabase.auth.signInWithOtp({
          email,
          options: {
            emailRedirectTo: window.location.origin + window.location.pathname
          }
        });

        if (error) {
          console.error('Email sign-in error:', error);
          alert('Could not send the sign-in email. Please try again.');
          return;
        }

        alert('Check your email for a sign-in link.');
      };

      const signOut = async () => {
        if (!ensureSupabase()) return;
        const { error } = await supabase.auth.signOut();
        if (error) {
          console.error('Sign out error:', error);
          alert('Could not sign out. Please try again.');
          return;
        }
        state.user = null;
        state.userProfile = null;
        showScreen('auth');
      };

      const getUserProfile = async (userId) => {
        const { data, error } = await supabase
          .from('users')
          .select('*')
          .eq('id', userId)
          .single();
        
        if (error) {
          console.error('Error fetching user profile:', error);
          return null;
        }
        return data;
      };

      const redirectToPayment = () => {
        // Add client_reference_id with user email for webhook matching
        const email = state.user?.email || '';
        const paymentLink = selectedPlan === 'annual' ? STRIPE_PAYMENT_LINK_ANNUAL : STRIPE_PAYMENT_LINK_MONTHLY;
        const paymentUrl = `${paymentLink}?prefilled_email=${encodeURIComponent(email)}&client_reference_id=${state.user?.id || ''}`;
        window.location.href = paymentUrl;
      };

      const handleSession = async (session) => {
        if (!session?.user) {
          state.user = null;
          state.userProfile = null;
          showScreen('auth');
          return;
        }

        state.user = session.user;
        userEmailDisplay.textContent = state.user.email || '';

        state.userProfile = await getUserProfile(state.user.id);
        if (!state.userProfile) {
          showScreen('auth');
          return;
        }

        if (state.userProfile.subscription_status === 'active') {
          showScreen('app');
          initApp();
        } else {
          showScreen('payment');
        }
      };

      const initAuth = async () => {
        showScreen('loading');
        if (!ensureSupabase()) {
          showScreen('auth');
          return;
        }

        const fallbackTimer = setTimeout(() => {
          if (!loadingScreen.classList.contains('hidden')) {
            console.warn('Loading timeout - forcing auth screen');
            showScreen('auth');
          }
        }, AUTH_TIMEOUT_MS);

        try {
          const sessionResult = await withTimeout(
            supabase.auth.getSession(),
            AUTH_TIMEOUT_MS,
            'Session check'
          );

          if (sessionResult.error) {
            console.error('Session error:', sessionResult.error);
            showScreen('auth');
          } else {
            await handleSession(sessionResult.data?.session);
          }
        } catch (err) {
          console.error('Auth initialization failed:', err);
          showScreen('auth');
        } finally {
          clearTimeout(fallbackTimer);
        }

        // Listen for auth changes
        supabase.auth.onAuthStateChange(async (event, session) => {
          try {
            if (event === 'SIGNED_OUT') {
              state.user = null;
              state.userProfile = null;
              showScreen('auth');
              return;
            }

            if (session?.user) {
              showScreen('loading');
              // Small delay to allow trigger to create user profile
              await new Promise(resolve => setTimeout(resolve, 1000));
              await handleSession(session);
            }
          } catch (err) {
            console.error('Auth state change error:', err);
            showScreen('auth');
          }
        });
      };

      // ==================== APP FUNCTIONS ====================
      const rewardMessages = {
        extra: "You're not alone in this. We'll keep it tiny and doable.",
        celebration: '',
      };

      const updateWelcome = () => {
        welcomeMessage.textContent = state.name ? `Hey ${state.name}.` : 'Hey there.';
        nameInline.textContent = state.name || 'friend';
      };

      const showOnboardingStep = (step) => {
        onboardingStep1.classList.toggle('hidden', step !== 1);
        onboardingStep2.classList.toggle('hidden', step !== 2);
        onboardingStep3.classList.toggle('hidden', step !== 3);
      };

      const completeOnboarding = () => {
        onboarding.classList.add('hidden');
        app.classList.remove('hidden');
        updateWelcome();
      };

      const initApp = () => {
        updateWelcome();

        if (!state.name) {
          onboarding.classList.remove('hidden');
          showOnboardingStep(1);
          return;
        }
        if (!state.struggle) {
          struggleGreeting.textContent = `Nice to meet you, ${state.name}. What's the paralysis feel like?`;
          onboarding.classList.remove('hidden');
          showOnboardingStep(2);
          return;
        }
        onboarding.classList.add('hidden');
        app.classList.remove('hidden');
      };

      // ==================== EVENT LISTENERS ====================
      // Auth buttons
      document.getElementById('google-login-btn').addEventListener('click', signInWithGoogle);
      document.getElementById('email-login-btn').addEventListener('click', signInWithEmail);
      document.getElementById('logout-btn').addEventListener('click', signOut);
      document.getElementById('logout-btn-payment').addEventListener('click', signOut);
      document.getElementById('checkout-btn').addEventListener('click', redirectToPayment);

      // Pricing toggle
      document.getElementById('plan-monthly').addEventListener('click', () => {
        selectedPlan = 'monthly';
        document.getElementById('plan-monthly').classList.add('bg-emerald-500', 'text-slate-950');
        document.getElementById('plan-monthly').classList.remove('text-slate-400');
        document.getElementById('plan-annual').classList.remove('bg-emerald-500', 'text-slate-950');
        document.getElementById('plan-annual').classList.add('text-slate-400');
        document.getElementById('price-monthly').classList.remove('hidden');
        document.getElementById('price-annual').classList.add('hidden');
        document.getElementById('checkout-btn-text').textContent = 'Subscribe for $7/month';
      });

      document.getElementById('plan-annual').addEventListener('click', () => {
        selectedPlan = 'annual';
        document.getElementById('plan-annual').classList.add('bg-emerald-500', 'text-slate-950');
        document.getElementById('plan-annual').classList.remove('text-slate-400');
        document.getElementById('plan-monthly').classList.remove('bg-emerald-500', 'text-slate-950');
        document.getElementById('plan-monthly').classList.add('text-slate-400');
        document.getElementById('price-annual').classList.remove('hidden');
        document.getElementById('price-monthly').classList.add('hidden');
        document.getElementById('checkout-btn-text').textContent = 'Subscribe for $60/year';
      });

      // Onboarding
      nameNext.addEventListener('click', () => {
        const nameValue = nameInput.value.trim();
        if (!nameValue) {
          nameInput.focus();
          return;
        }
        state.name = nameValue;
        localStorage.setItem('nudge.name', state.name);
        struggleGreeting.textContent = `Nice to meet you, ${state.name}. What's the paralysis feel like?`;
        showOnboardingStep(2);
      });

      struggleOptions.forEach((button) => {
        button.addEventListener('click', () => {
          const value = button.textContent.trim();
          struggleInput.value = value;
        });
      });

      struggleNext.addEventListener('click', () => {
        const value = struggleInput.value.trim();
        if (!value) {
          struggleInput.focus();
          return;
        }
        state.struggle = value;
        localStorage.setItem('nudge.struggle', state.struggle);
        showOnboardingStep(3);
      });

      onboardingCompleteBtn.addEventListener('click', () => {
        completeOnboarding();
      });

      // Task breakdown
      const rollRewardMode = () => {
        const roll = Math.random();
        if (roll < 0.1) return 'celebration';
        if (roll < 0.3) return 'extra';
        return 'normal';
      };

      const parseSteps = (content) =>
        content
          .split('\n')
          .map((line) => line.replace(/^\s*\d+[\).\-]*\s*/, '').trim())
          .filter((line) => line.length > 0 && !line.match(/encouraging/i));

      const updateProgress = () => {
        const total = state.steps.length;
        const completed = Math.min(state.currentIndex, total);
        const percent = total ? Math.round((completed / total) * 100) : 0;
        progressBar.style.width = `${percent}%`;
        stepCount.textContent = Math.min(state.currentIndex + 1, total);
        stepTotal.textContent = total;
      };

      const showStep = () => {
        if (!state.steps.length) return;
        if (state.currentIndex >= state.steps.length) {
          stepsCard.classList.add('hidden');
          completionCard.classList.remove('hidden');
          confetti({ particleCount: 120, spread: 70, origin: { y: 0.6 } });
          return;
        }
        currentStep.textContent = state.steps[state.currentIndex];
        stepsCard.classList.remove('hidden');
        completionCard.classList.add('hidden');
        updateProgress();
      };

      const scrollToSteps = () => {
        const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        const behavior = prefersReducedMotion ? 'auto' : 'smooth';
        window.requestAnimationFrame(() => {
          stepsCard.scrollIntoView({ behavior, block: 'start' });
        });
      };

      const showRewardBanner = () => {
        if (state.rewardMode === 'extra') {
          rewardBanner.textContent = rewardMessages.extra;
          rewardBanner.classList.remove('hidden');
        } else if (state.rewardMode === 'celebration') {
          rewardBanner.textContent = `Celebration mode unlocked. ${state.name}, I'm cheering for you.`;
          rewardBanner.classList.remove('hidden');
        } else {
          rewardBanner.classList.add('hidden');
        }
      };

      const requestBreakdown = async () => {
        const task = taskInput.value.trim();
        if (!task) {
          statusMessage.textContent = 'Tell me what you are avoiding so I can make it tiny.';
          return;
        }
        statusMessage.textContent = 'Brewing tiny steps…';
        breakdownButton.disabled = true;
        breakdownButton.classList.add('opacity-70', 'cursor-not-allowed');
        state.rewardMode = rollRewardMode();

        try {
          const response = await fetch('/api/generate-steps', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              task,
              struggle: state.struggle,
              name: state.name,
              rewardMode: state.rewardMode,
            }),
          });

          if (!response.ok) {
            throw new Error('API request failed');
          }

          const data = await response.json();
          const content = data.content || '';
          const steps = parseSteps(content);

          if (!steps.length) {
            throw new Error('No steps returned');
          }

          state.steps = steps;
          state.currentIndex = 0;
          statusMessage.textContent = 'Okay, tiny steps coming right up.';
          showRewardBanner();
          showStep();
          scrollToSteps();
        } catch (error) {
          statusMessage.textContent = 'Something went wrong. Please try again.';
          stepsCard.classList.add('hidden');
        } finally {
          breakdownButton.disabled = false;
          breakdownButton.classList.remove('opacity-70', 'cursor-not-allowed');
        }
      };

      breakdownButton.addEventListener('click', requestBreakdown);

      doneButton.addEventListener('click', () => {
        state.currentIndex += 1;
        showStep();
      });

      skipButton.addEventListener('click', () => {
        state.currentIndex += 1;
        showStep();
      });

      // ==================== INIT ====================
      // Start auth initialization
      initAuth();
    </script>
  </body>
</html>
